# AWS SAM Serverless FastAPI

This project is trying to mimic the future setup of Symployees application's backend that is used for signing in when you come to Belgrade Hub. Currently, API is working in an ECS, but we would like to move it to Lambdas in order to reduce the price.

Current API has both functionalities needed not only for Mobile and Back-office applications, but also for importing list of employees from CSV files, that are generated by the Core Tool. More info here <https://teamsymphony.atlassian.net/wiki/spaces/SI/pages/3960504338/Architecture> and code is here <https://github.com/search?q=org%3Asymphonygroup+symployees>.

What we want to accomplish is to:

- Separate backend to several Lambda functions
  - FastAPI to support Mobile and Back-Office applications (that can be separated further)
  - Lambda for importing employee list from Core Tool CSV
  - (Future) Lambda for importing ID cards from also CSV file
- Reduce cost
- Remove SQS as S3 will trigger Lambdas directly (SQS was not necessary, more for learning how to work with broker)
- Learn to work with some serverless "framework", in this case AWS SAM
  - There was an option to try serverless.com, but SAM is AWS specific and I wanted to avoid potential issues with "generic" frameworks that are not officially supported

There were also some additional decisions I made along the way:

- Use approach to have all lambdas inside one project/repository as functionalities are a logical service
- Have one of the Lambdas implemented as a FastAPI in order not to have dozens of functions  

## Setup AWS SAM

- Install AWS CLI - `https://formulae.brew.sh/formula/awscli`
- Install AWS SAM CLI
  - `brew tap aws/tap`
  - `brew install aws-sam-cli`

In order to build current stack run `sam build`.

Setup you AWS credentials if you want to run all on your AWS account.

In order to deploy it to AWS, run `sam deploy`. Before that change in `template.yaml` BucketNamePrefix.

## Configure AWS credentials for Local testing

Run `aws configure --profile local` and set:

- AWS Access Key to `awslocal`
- AWS Secret to `awslocal`
- Default Region to `eu-central-1`
- Default output format to `json`

We will need this later for running lambdas locally.

## Explanation of SAM Template.yaml

### Setup single API Gateway

Setup just one API Gateway for multiple Lambda or even multiple FastAPIs.

```yaml
Resources:

  ApiGatewayApi:
    Type: AWS::Serverless::HttpApi
```

### Setup your FastAPI correctly

If you would like to have your FastAPI on a suffix path, e.g. `/api`, you need to do two things

#### Setup path for Function/FastAPI

In `template.yaml` in Events, setup Path in Properties as in a sample.
If it is a FastAPI, you need to setup 2 Events, for both Root and non-Root paths, where non-Root should be `{proxy+}`.

#### Change URL prefix in your FastAPI project

If you in a previous step setup, for example, `/api` prefix, you need to also setup that prefix to all routes in your FastAPI project, e.g. `@app.get("/api/test")`

Better option is to use Routers and to have that prefix in the definition of the router

```python
router = APIRouter(
    prefix="/api"
)
```

You can event use some prefix string and read it from environment variable, so it can be setup in CI/CD pipeline.

## Start FastAPI lambda locally

First build your lambdas with `sam build`.

`sam local start-api --warm-containers EAGER`
It is important to warm up containers, so only first response is slow and not every.

## Start Import Employees Lambda locally

Start docker compose file with `docker compose up`. This will start a MinIO (S3 compatible service) and create a `symphony-symployees-core-export` bucket. Since MinIO is already mapped to `_local/s3` directory, it will have `test1.png` in a directory with the bucket name.

First build your lambdas with `sam build`.

Then run this command

`sam local generate-event s3 put --bucket symphony-symployees-core-export --key "test1.png" | sam local invoke -e - ImportEmployeesLambda --env-vars env.json --profile local`

What this command does is:

1. Creates a S3 event, with specific Bucket name and Key (file in the bucket). It will access to a local S3 bucket (MinIO from Docker Compose) and try to locate file with this name.
2. Passes that event to lambda that is ran locally, so ImportEmployeesLambda will download the file, process it and return output (in this example - content type of the file).
3. This command uses `env.json` file with environment variables, where we explicitly set URL to local S3 (MinIO)
4. This command uses `--profile local` in order to use AWS credentials that are appropriate for local testing.

## Delete all resources

When you are done with testing, you should clean up all of the resources, in order not to be charged if not using them.

`sam delete`

You should previously remove all files from your S3 buckets as they can't be removed if there are some files in them.
